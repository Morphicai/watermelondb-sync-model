# ç™¾å˜AIåŠ©æ‰‹ï¼šOffline First æ•°æ®åŒæ­¥æ–¹æ¡ˆ

> ğŸš€ å¼€æºåœ°å€ï¼š[https://github.com/Morphicai/watermelondb-sync-model](https://github.com/Morphicai/watermelondb-sync-model)  
> åŸºäº WatermelonDB + Supabase çš„ç¦»çº¿ä¼˜å…ˆæ•°æ®åŒæ­¥å¼•æ“

---

## ğŸ“Œ å…³äºæœ¬æ–‡

æœ¬æ–‡æ€»ç»“äº†ç™¾å˜AIåŠ©æ‰‹ä¸­æ•°æ®åŒæ­¥çš„å®Œæ•´å®ç°æ€è·¯ï¼ŒåŒ…æ‹¬æˆ‘ä»¬è¸©è¿‡çš„å‘å’Œè§£å†³æ–¹æ¡ˆã€‚ä»£ç å¼€æºåœ¨ GitHubï¼Œä½†ä¸æ˜¯å¼€ç®±å³ç”¨çš„ â€”â€” è¿™æ˜¯ä»ç”Ÿäº§é¡¹ç›®ä¸­æå–çš„æ ¸å¿ƒé€»è¾‘ã€‚é…åˆ AI å·¥å…·ï¼ˆClaudeã€GPT-4 ç­‰ï¼‰ç†è§£æ–‡ç« å†…å®¹åï¼Œå¯ä»¥é€‚é…åˆ°è‡ªå·±çš„é¡¹ç›®ä¸­ã€‚

---

## å‰è¨€

ç™¾å˜AIåŠ©æ‰‹æ˜¯ä¸€ä¸ª AI é©±åŠ¨çš„åº”ç”¨ç”Ÿæˆå¹³å°ï¼Œç”¨æˆ·é€šè¿‡è‡ªç„¶è¯­è¨€ç”Ÿæˆå„ç§å°å·¥å…·ï¼ˆå¾…åŠæ¸…å•ã€è®°è´¦å·¥å…·ã€ä¹ æƒ¯è¿½è¸ªå™¨ç­‰ï¼‰ï¼Œè¿™äº›å·¥å…·ç«‹å³åœ¨åº”ç”¨å†…è¿è¡Œã€‚

æ ¸å¿ƒé—®é¢˜ï¼š**ç”¨æˆ·åœ¨ AI ç”Ÿæˆçš„å°å·¥å…·ä¸­äº§ç”Ÿçš„æ•°æ®ï¼Œå¦‚ä½•åœ¨å¤šè®¾å¤‡é—´å®æ—¶åŒæ­¥ï¼Ÿ**

åœºæ™¯ï¼šç”¨æˆ·åœ¨æ‰‹æœºä¸Šè®°å½•å¥èº«æ•°æ®ï¼Œåˆ°åŠå…¬å®¤ç”¨ç”µè„‘æŸ¥çœ‹ï¼›åœ¨å¹³æ¿ä¸Šç¼–è¾‘ç¬”è®°ï¼Œæ‰‹æœºä¸Šç»§ç»­ä¿®æ”¹ â€”â€” æ‰€æœ‰è®¾å¤‡æ•°æ®ä¿æŒä¸€è‡´ï¼Œç¦»çº¿ä¹Ÿèƒ½ä½¿ç”¨ã€‚

æŠ€æœ¯è¦æ±‚ï¼š
- ç¦»çº¿ä¼˜å…ˆ - æ— ç½‘ç»œç¯å¢ƒä¸‹æµç•…ä½¿ç”¨
- å®æ—¶åŒæ­¥ - å¤šè®¾å¤‡æ•°æ®ç§’çº§åŒæ­¥  
- å†²çªè§£å†³ - è‡ªåŠ¨å¤„ç†å¤šç«¯ç¼–è¾‘
- é«˜æ€§èƒ½ - æ”¯æŒä¸‡çº§æ•°æ®

æˆ‘ä»¬åŸºäº WatermelonDB + Supabase æ„å»ºäº†è¿™ä¸ªåŒæ­¥å¼•æ“ï¼Œå¹¶å°†æ ¸å¿ƒä»£ç å¼€æºã€‚

---

## WatermelonDB ç®€ä»‹

[WatermelonDB](https://github.com/Nozbe/WatermelonDB) æ˜¯ä¸€ä¸ªé«˜æ€§èƒ½çš„å“åº”å¼æ•°æ®åº“ï¼Œæ”¯æŒ React Native å’Œ Reactï¼ˆWebï¼‰åº”ç”¨ã€‚

**æ ¸å¿ƒç‰¹ç‚¹ï¼š**
- **æ‡’åŠ è½½** - ä¸ä¼šä¸€æ¬¡æ€§åŠ è½½æ‰€æœ‰æ•°æ®åˆ°å†…å­˜
- **å“åº”å¼** - æ•°æ®å˜åŒ–è‡ªåŠ¨è§¦å‘ UI æ›´æ–°
- **é«˜æ€§èƒ½** - ä¸‡çº§æ•°æ®ä¾ç„¶æµç•…
- **è·¨å¹³å°** - iOS/Androidï¼ˆSQLiteï¼‰ã€Webï¼ˆIndexedDBï¼‰ç»Ÿä¸€ API

### åŸºç¡€ä½¿ç”¨ç¤ºä¾‹

ä¸€ä¸ªå…¸å‹çš„ WatermelonDB åº”ç”¨ï¼ˆä¸å¸¦åŒæ­¥ï¼‰ï¼š

```typescript
// 1. å®šä¹‰æ•°æ®æ¨¡å‹
import { Model } from '@nozbe/watermelondb';
import { field, date } from '@nozbe/watermelondb/decorators';

export class Task extends Model {
  static table = 'tasks';
  
  @field('title') title!: string;
  @field('completed') completed!: boolean;
  @date('created_at') createdAt!: Date;
}

// 2. åˆ›å»ºæ•°æ®åº“
import { Database } from '@nozbe/watermelondb';
import SQLiteAdapter from '@nozbe/watermelondb/adapters/sqlite';

const adapter = new SQLiteAdapter({
  schema,
  dbName: 'myapp',
});

const database = new Database({
  adapter,
  modelClasses: [Task],
});

// 3. å¢åˆ æ”¹æŸ¥
// åˆ›å»º
const newTask = await database.write(async () => {
  return await database.get('tasks').create(task => {
    task.title = 'å®ŒæˆæŠ€æœ¯æ–‡æ¡£';
    task.completed = false;
  });
});

// æŸ¥è¯¢ï¼ˆå“åº”å¼ï¼‰
const tasks = database.get('tasks')
  .query()
  .observe(); // è¿”å› Observableï¼Œæ•°æ®å˜åŒ–æ—¶è‡ªåŠ¨æ›´æ–°

// æ›´æ–°
await newTask.update(task => {
  task.completed = true;
});

// åˆ é™¤
await newTask.markAsDeleted();
```

### ä¸ºä»€ä¹ˆéœ€è¦åŒæ­¥ï¼Ÿ

ä¸Šé¢çš„ä»£ç å¯ä»¥å®Œç¾è¿è¡Œåœ¨å•ä¸ªè®¾å¤‡ä¸Šï¼Œä½†å­˜åœ¨é—®é¢˜ï¼š

```
âŒ é—®é¢˜ 1ï¼šæ•°æ®å­¤å²›
ç”¨æˆ·åœ¨æ‰‹æœºä¸Šåˆ›å»ºçš„ä»»åŠ¡ï¼Œç”µè„‘ä¸Šçœ‹ä¸åˆ°

âŒ é—®é¢˜ 2ï¼šæ•°æ®ä¸¢å¤±é£é™©
è®¾å¤‡æŸåæˆ–å¸è½½åº”ç”¨ï¼Œæ•°æ®æ°¸ä¹…ä¸¢å¤±

âŒ é—®é¢˜ 3ï¼šæ— æ³•åä½œ
æ— æ³•ä¸å…¶ä»–ç”¨æˆ·å…±äº«æˆ–åä½œç¼–è¾‘æ•°æ®
```

è¿™å°±æ˜¯æˆ‘ä»¬éœ€è¦åŒæ­¥çš„åŸå› ã€‚WatermelonDB æä¾›äº† `synchronize()` APIï¼Œä½†éœ€è¦æˆ‘ä»¬è‡ªå·±å®ç°å…·ä½“çš„åŒæ­¥é€»è¾‘ â€”â€” è¿™å°±æ˜¯æœ¬æ–‡çš„æ ¸å¿ƒå†…å®¹ã€‚

---

## æ¶æ„è®¾è®¡

### æ ¸å¿ƒç†å¿µ

æˆ‘ä»¬çš„åŒæ­¥ç³»ç»Ÿéµå¾ªä¸‰å¤§è®¾è®¡åŸåˆ™ï¼š

1. **å£°æ˜å¼åŒæ­¥é…ç½®** - é€šè¿‡ç»§æ‰¿ `SyncModel` ç±»ï¼Œåªéœ€å£°æ˜å­—æ®µæ˜ å°„å’Œè½¬æ¢è§„åˆ™ï¼Œæ¡†æ¶è‡ªåŠ¨å¤„ç†æ‰€æœ‰åŒæ­¥é€»è¾‘
2. **åŒå‘å¢é‡åŒæ­¥** - åŸºäºæ—¶é—´æˆ³çš„æ™ºèƒ½å¢é‡åŒæ­¥ï¼Œæœ€å°åŒ–ç½‘ç»œä¼ è¾“
3. **è¡¥å¿å¼ä¸€è‡´æ€§** - é€šè¿‡è¡¥å¿å¾ªç¯ç¡®ä¿æ•°æ®æœ€ç»ˆä¸€è‡´æ€§

### ç³»ç»Ÿæ¶æ„å›¾

```mermaid
graph TB
    DSM[DataSyncManager<br/>æ€»æ§åˆ¶å™¨ï¼šç¼–æ’æ‰€æœ‰æ¨¡å‹çš„åŒæ­¥æµç¨‹]
    
    DSM --> ASC[AutoSyncController<br/>è‡ªåŠ¨åŒæ­¥ + é˜²æŠ–]
    DSM --> SEB[SyncEventBus<br/>äº‹ä»¶æ€»çº¿]
    DSM --> SM[å¤šä¸ª SyncModel å®ä¾‹]
    
    SM --> SA[SyncAdapter<br/>é€‚é…å™¨æ¥å£]
    SM --> SC[SuppressionCounter<br/>é˜²å¾ªç¯åŒæ­¥]
    
    SA --> SUA[SupabaseAdapter<br/>Supabase å®ç°]
    
    SUA --> LDA[LocalDataAccessor<br/>æœ¬åœ°æ•°æ®è®¿é—®]
    SUA --> SBC[Supabase Client<br/>è¿œç«¯æ•°æ®è®¿é—®]
    
    style DSM fill:#e1f5ff
    style ASC fill:#fff4e6
    style SEB fill:#fff4e6
    style SM fill:#e8f5e9
    style SA fill:#f3e5f5
    style SUA fill:#fce4ec
```

---

## æ ¸å¿ƒç»„ä»¶è¯¦è§£

### 1ï¸âƒ£ SyncModel - åŒæ­¥æ¨¡å‹åŸºç±»

`SyncModel` ç»§æ‰¿è‡ª WatermelonDB çš„ `Model` ç±»ï¼Œåœ¨ä¿ç•™åŸæœ‰åŠŸèƒ½çš„åŸºç¡€ä¸Šï¼Œå¢åŠ äº†åŒå‘åŒæ­¥èƒ½åŠ›ã€‚

**ç»§æ‰¿å…³ç³»ï¼š**
```typescript
// WatermelonDB åŸç”Ÿ Model
class Model { ... }

// æˆ‘ä»¬çš„ SyncModel ç»§æ‰¿ Model
export abstract class SyncModel<LocalRaw, RemoteRow> extends Model {
  // ç»§æ‰¿äº† Model çš„æ‰€æœ‰åŠŸèƒ½ï¼ˆCRUDã€å“åº”å¼ç­‰ï¼‰
  // + æ–°å¢åŒæ­¥ç›¸å…³çš„é™æ€é…ç½®å’Œæ–¹æ³•
}

// ä½ çš„ä¸šåŠ¡æ¨¡å‹ç»§æ‰¿ SyncModel
export class Task extends SyncModel<LocalTaskRaw, RemoteTask> {
  // ç»§æ‰¿äº† Model çš„æ‰€æœ‰åŠŸèƒ½
  // + ç»§æ‰¿äº† SyncModel çš„åŒæ­¥åŠŸèƒ½
  // + ä½ çš„ä¸šåŠ¡å­—æ®µå’Œé€»è¾‘
}
```

**å®é™…ä½¿ç”¨ï¼š**
```typescript
export class Task extends SyncModel<LocalTaskRaw, RemoteTask> {
  // ===== æ¥è‡ª WatermelonDB Model çš„åŠŸèƒ½ =====
  @text('title') title!: string;
  @text('remote_id') remoteId!: string;
  @date('updated_at') updatedAt!: Date;
  // ç»§æ‰¿çš„æ–¹æ³•ï¼šupdate()ã€markAsDeleted()ã€observe() ç­‰
  
  // ===== æ¥è‡ª SyncModel çš„åŠŸèƒ½ï¼ˆéœ€è¦å®ç°ï¼‰ =====
  
  // ğŸ”§ é…ç½®è¿œç«¯è¡¨å
  static remoteTable = 'tasks';
  
  // ğŸ”§ é…ç½®ä¸»é”®å’Œå”¯ä¸€é”®æ˜ å°„
  static syncKeys = {
    remotePk: 'id',              // è¿œç«¯ä¸»é”®
    localRemoteId: 'remote_id',  // æœ¬åœ°å­˜å‚¨è¿œç«¯ ID çš„å­—æ®µ
    uniqueKey: {                 // å”¯ä¸€é”®çº¦æŸï¼ˆå¯é€‰ï¼‰
      local: 'title',
      remote: 'title'
    }
  };
  
  // ğŸ”§ é…ç½®æ—¶é—´æˆ³å­—æ®µï¼ˆç”¨äºå†²çªæ£€æµ‹ï¼‰
  static syncTimestamps = {
    local: 'updated_at',
    remote: 'updated_at'
  };
  
  // ğŸ”§ é…ç½®ç”¨æˆ·éš”ç¦»ï¼ˆå¤šç§Ÿæˆ·ï¼‰
  static scope = {
    userField: 'user_id'
  };
  
  // â¬‡ï¸ ä¸‹è¡Œæ•°æ®è½¬æ¢ï¼šè¿œç«¯ â†’ æœ¬åœ°
  static remoteToLocal(row: RemoteTask, ctx: SyncContext): LocalTaskRaw {
    return {
      id: `tasks:${row.id}`,  // ç”Ÿæˆæœ¬åœ° ID
      title: row.title,
      remote_id: row.id,
      user_id: row.user_id,
      updated_at: Date.parse(row.updated_at)
    };
  }
  
  // â¬†ï¸ ä¸Šè¡Œæ•°æ®è½¬æ¢ï¼šæœ¬åœ° â†’ è¿œç«¯
  localToRemote(ctx: SyncContext): Partial<RemoteTask> {
    return {
      title: this.title,
      user_id: ctx.userId,
      updated_at: new Date(this.updatedAt).toISOString()
    };
  }
}
```

**ä¸ºä»€ä¹ˆè¦ç»§æ‰¿ Modelï¼Ÿ**

è¿™æ ·è®¾è®¡çš„å¥½å¤„ï¼š
- âœ… **å…¼å®¹æ€§** - å®Œå…¨å…¼å®¹ WatermelonDB çš„æ‰€æœ‰ API å’Œè£…é¥°å™¨
- âœ… **æ¸è¿›å¼** - å·²æœ‰çš„ Model å¯ä»¥å¹³æ»‘å‡çº§ä¸º SyncModel
- âœ… **ç±»å‹å®‰å…¨** - TypeScript å®Œæ•´çš„ç±»å‹æ¨å¯¼
- âœ… **æœ€å°ä¾µå…¥** - ä¸æ”¹å˜åŸæœ‰çš„ä½¿ç”¨æ–¹å¼ï¼Œåªéœ€å¢åŠ åŒæ­¥é…ç½®

**ä½¿ç”¨ SyncModel çš„å®Œæ•´ç¤ºä¾‹ï¼š**

```typescript
export class Task extends SyncModel<LocalTaskRaw, RemoteTask> {
  static table = 'tasks';  // WatermelonDB å¿…éœ€
  
  // WatermelonDB å­—æ®µå®šä¹‰
  @text('title') title!: string;
  @text('remote_id') remoteId!: string;
  @date('updated_at') updatedAt!: Date;
  
  // SyncModel åŒæ­¥é…ç½®
  static remoteTable = 'tasks';
  static syncKeys = { remotePk: 'id', localRemoteId: 'remote_id' };
  static syncTimestamps = { local: 'updated_at', remote: 'updated_at' };
  
  // æ•°æ®è½¬æ¢æ–¹æ³•
  static remoteToLocal(row: RemoteTask): LocalTaskRaw { ... }
  localToRemote(): Partial<RemoteTask> { ... }
}

// ä½¿ç”¨æ—¶ï¼Œå’Œæ™®é€š Model ä¸€æ ·
const task = await database.get('tasks').create(t => {
  t.title = 'å®Œæˆæ–‡æ¡£';
  // ä¼šè‡ªåŠ¨è§¦å‘åŒæ­¥ï¼
});
```

**å…³é”®é…ç½®é¡¹è¯´æ˜ï¼š**

- `syncKeys.uniqueKey` - æ”¯æŒå•ä¸€æˆ–è”åˆå”¯ä¸€é”®ï¼Œç”¨äºé¦–æ¬¡åŒæ­¥æ—¶åŒ¹é…å·²å­˜åœ¨çš„è®°å½•
- `syncTimestamps` - åŒç«¯æ—¶é—´æˆ³å¯¹æ¯”ï¼Œå®ç°"åå†™å…¥è·èƒœ"çš„å†²çªè§£å†³ç­–ç•¥
- `scope.userField` - è‡ªåŠ¨è¿‡æ»¤å½“å‰ç”¨æˆ·çš„æ•°æ®ï¼Œé…åˆ Supabase RLS å®ç°æ•°æ®éš”ç¦»

### 2ï¸âƒ£ SyncAdapter - é€‚é…å™¨æ¥å£

`SyncAdapter` æ˜¯è¿æ¥æœ¬åœ°æ•°æ®åº“å’Œè¿œç«¯æ•°æ®æºçš„æ¡¥æ¢ï¼Œå®šä¹‰äº†åŒæ­¥çš„æ ¸å¿ƒå¥‘çº¦ã€‚

**æ¥å£è®¾è®¡ï¼š**

```typescript
export interface SyncAdapter<LocalRaw, RemoteRow> {
  // ä¸‹è¡ŒåŒæ­¥ï¼šä»è¿œç«¯æ‹‰å–æ•°æ®
  pull(
    lastPulledAt: number | null,  // ä¸Šæ¬¡åŒæ­¥æ—¶é—´
    ctx?: SyncContext              // åŒæ­¥ä¸Šä¸‹æ–‡ï¼ˆå¦‚ userIdï¼‰
  ): Promise<PullResult<LocalRaw>>;
  
  // ä¸Šè¡ŒåŒæ­¥ï¼šæ¨é€æœ¬åœ°å˜æ›´åˆ°è¿œç«¯
  push(
    changes: TableChanges<LocalRaw>,  // WatermelonDB æä¾›çš„å˜æ›´
    ctx?: SyncContext
  ): Promise<void>;
  
  // è®¢é˜…è¿œç«¯æ•°æ®å˜åŒ–ï¼ˆå¯é€‰ï¼‰
  subscribeToRemoteChanges(
    ctx?: SyncContext,
    onChange?: (payload?: unknown) => void
  ): RemoteSubscription;
}
```

**æ ¸å¿ƒæ•°æ®ç»“æ„ï¼š**

```typescript
// Pull è¿”å›ç»“æœ
interface PullResult<LocalRaw> {
  created: LocalRaw[];  // æ–°å»ºè®°å½•
  updated: LocalRaw[];  // æ›´æ–°è®°å½•
  deleted: string[];    // åˆ é™¤è®°å½•çš„ ID åˆ—è¡¨
}

// Push è¾“å…¥å‚æ•°
interface TableChanges<LocalRaw> {
  created: LocalRaw[];  // æœ¬åœ°æ–°å»ºçš„è®°å½•
  updated: LocalRaw[];  // æœ¬åœ°æ›´æ–°çš„è®°å½•
  deleted: string[];    // æœ¬åœ°åˆ é™¤çš„è®°å½• ID
}
```

**BaseSyncAdapter åŸºç±»ï¼š**

æä¾›äº†é€šç”¨çš„å·¥å…·æ–¹æ³•ï¼Œç®€åŒ–å­ç±»å®ç°ï¼š

```typescript
export abstract class BaseSyncAdapter<LocalRaw, RemoteRow> 
  implements SyncAdapter<LocalRaw, RemoteRow> {
  
  protected readonly database: Database;
  protected readonly ModelCtor: SyncModelCtor;
  protected readonly localData: LocalDataAccessor;  // æœ¬åœ°æ•°æ®è®¿é—®å·¥å…·
  
  // å­ç±»å¿…é¡»å®ç°
  abstract pull(lastPulledAt, ctx?): Promise<PullResult>;
  abstract push(changes, ctx?): Promise<void>;
  
  // é€šç”¨å·¥å…·æ–¹æ³•
  protected normalizeUniqueSpecs(uniqueKey): UniqueKeySpec[] { ... }
  protected getRemoteUniqueKey(row, uniqueSpecs): string { ... }
  protected normalizeSoftDelete(row, field?): boolean { ... }
  protected serializeUniqueValues(values): string { ... }
}
```

**ä¸ºä»€ä¹ˆéœ€è¦é€‚é…å™¨æ¨¡å¼ï¼Ÿ**

```typescript
// è§£è€¦æ•°æ®æº
SyncModel â†’ SyncAdapter â†’ è¿œç«¯æ•°æ®æº
            â†“
    SupabaseAdapter (Supabase)
    FirebaseAdapter (Firebase)
    GraphQLAdapter (GraphQL API)
    RestAdapter (REST API)
```

è¿™æ ·è®¾è®¡çš„å¥½å¤„ï¼š
- æ›´æ¢æ•°æ®æºæ—¶ï¼Œåªéœ€å®ç°æ–°çš„ Adapter
- SyncModel å’Œ DataSyncManager æ— éœ€ä¿®æ”¹
- å¯ä»¥ä¸ºä¸åŒçš„è¡¨ä½¿ç”¨ä¸åŒçš„ Adapter

**SupabaseAdapter å®ç°ç¤ºä¾‹ï¼š**

æˆ‘ä»¬æä¾›äº†åŸºäº Supabase çš„å®Œæ•´å®ç°ï¼ˆè§ä»£ç ä»“åº“ï¼‰ï¼Œæ ¸å¿ƒé€»è¾‘ï¼š

```typescript
export class SupabaseAdapter extends BaseSyncAdapter {
  async pull(lastPulledAt, ctx) {
    // 1. æŸ¥è¯¢è¿œç«¯æ›´æ–°çš„æ•°æ®
    const { data } = await supabase
      .from(this.ModelCtor.remoteTable)
      .select('*')
      .gte('updated_at', new Date(lastPulledAt).toISOString())
      .eq('user_id', ctx.userId);
    
    // 2. åŒ¹é…æœ¬åœ°è®°å½•ï¼ˆé€šè¿‡ remote_id æˆ–å”¯ä¸€é”®ï¼‰
    // 3. åˆ†ç±»ä¸º created/updated/deleted
    // 4. è°ƒç”¨ remoteToLocal è½¬æ¢æ•°æ®
    
    return { created, updated, deleted };
  }
  
  async push(changes, ctx) {
    // 1. å¤„ç†åˆ é™¤ï¼ˆè½¯åˆ é™¤æ ‡è®°ï¼‰
    // 2. å¤„ç†åˆ›å»ºå’Œæ›´æ–°ï¼ˆINSERT or UPDATEï¼‰
    // 3. å†™å› remote_id åˆ°æœ¬åœ°
  }
  
  subscribeToRemoteChanges(ctx, onChange) {
    // ä½¿ç”¨ Supabase Realtime è®¢é˜…è¡¨å˜åŒ–
    const channel = supabase.channel(`sync-${table}`)
      .on('postgres_changes', { event: '*', table }, onChange)
      .subscribe();
    
    return { unsubscribe: () => supabase.removeChannel(channel) };
  }
}
```

### 3ï¸âƒ£ DataSyncManager - åŒæ­¥æ€»æ§

`DataSyncManager` æ˜¯æ•´ä¸ªåŒæ­¥ç³»ç»Ÿçš„å¤§è„‘ï¼Œè´Ÿè´£ï¼š

- ğŸ“‹ æ³¨å†Œå’Œç®¡ç†æ‰€æœ‰åŒæ­¥æ¨¡å‹
- ğŸ”„ ç¼–æ’ Pull/Push åŒæ­¥æµç¨‹
- ğŸ¯ è§¦å‘è¡¥å¿å¾ªç¯ç¡®ä¿ä¸€è‡´æ€§
- ğŸ“¡ ç®¡ç†æœ¬åœ°å˜æ›´ç›‘å¬å’Œè¿œç«¯å®æ—¶è®¢é˜…

```typescript
// åˆ›å»ºåŒæ­¥ç®¡ç†å™¨
const syncManager = new DataSyncManager(
  database,
  [Task, Note, Message],  // æ³¨å†Œæ‰€æœ‰éœ€è¦åŒæ­¥çš„æ¨¡å‹
  { debounceMs: 3000 }    // é˜²æŠ–æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
);

// å¯åŠ¨åŒæ­¥ï¼ˆæ‰§è¡Œåˆå§‹åŒæ­¥ + å¯ç”¨è‡ªåŠ¨åŒæ­¥ï¼‰
await syncManager.start(
  { userId: currentUser.id },
  { auto: true }  // å¯ç”¨è‡ªåŠ¨åŒæ­¥
);

// æ‰‹åŠ¨è§¦å‘åŒæ­¥
await syncManager.syncNow({ userId: currentUser.id });

// ç›‘å¬åŒæ­¥äº‹ä»¶
syncManager.on((event) => {
  if (event.type === 'pulled') {
    console.log(`${event.label} ä¸‹è¡ŒåŒæ­¥å®Œæˆ`, event.detail);
  }
  if (event.type === 'error') {
    console.error(`${event.label} åŒæ­¥å¤±è´¥`, event.detail);
  }
});

// å¯åŠ¨è¿œç«¯å®æ—¶è®¢é˜…ï¼ˆå¯é€‰ï¼‰
syncManager.startRemoteSubscriptions();
```

### 4ï¸âƒ£ LocalDataAccessor - æœ¬åœ°æ•°æ®è®¿é—®

å°è£…äº†æ‰€æœ‰æœ¬åœ° WatermelonDB çš„æ“ä½œï¼Œæä¾›ç»Ÿä¸€çš„æ•°æ®è®¿é—®æ¥å£ï¼š

```typescript
export class LocalDataAccessor {
  // æ ¹æ® remote_id æŸ¥æ‰¾æœ¬åœ°è®°å½•
  async findByRemoteId(localRemoteIdKey, remoteIdValue): Promise<Model | null>
  
  // æ„å»ºå”¯ä¸€é”®ç´¢å¼•ï¼ˆç”¨äºé¦–æ¬¡åŒæ­¥åŒ¹é…ï¼‰
  async buildUniqueIndex(uniqueSpecs): Promise<Map<string, Model>>
  
  // è¯»å–å­—æ®µå€¼ï¼ˆæ”¯æŒ snake_case/camelCase è½¬æ¢ï¼‰
  readField(record, fieldName): any
  
  // è·å–æ—¶é—´æˆ³ï¼ˆç»Ÿä¸€è½¬æ¢ä¸ºæ¯«ç§’ï¼‰
  getTimestamp(record, fieldName): number
  
  // åœ¨æŠ‘åˆ¶ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œï¼ˆé¿å…è§¦å‘åŒæ­¥ï¼‰
  updateWithoutSync(fn): Promise<void>
}
```

---

## åŒæ­¥æµç¨‹è¯¦è§£

åœ¨æ·±å…¥ä¸€è‡´æ€§æœºåˆ¶ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆäº†è§£ WatermelonDB çš„åŒæ­¥æµç¨‹ã€‚**å…³é”®ç‚¹ï¼šPull å’Œ Push æœ‰ä¸¥æ ¼çš„æ‰§è¡Œé¡ºåºã€‚**

### ğŸ“‹ å•æ¬¡åŒæ­¥å¾ªç¯æµç¨‹æ¦‚è§ˆ

```mermaid
graph TD
    Start[ğŸš€ å¼€å§‹åŒæ­¥] --> GetTime[è·å–æœåŠ¡å™¨æ—¶é—´æˆ³<br/>pullStartedAt]
    
    GetTime --> PullPhase[â‘  Pull é˜¶æ®µ<br/>ä¸‹è¡ŒåŒæ­¥]
    PullPhase --> PushPhase[â‘¡ Push é˜¶æ®µ<br/>ä¸Šè¡ŒåŒæ­¥]
    
    PushPhase --> CheckPending{åŒæ­¥æœŸé—´<br/>æœ‰æ–°å˜æ›´?}
    
    CheckPending -->|æ˜¯| Compensation[ğŸ”„ è§¦å‘è¡¥å¿å¾ªç¯]
    CheckPending -->|å¦| Complete[ğŸ‰ åŒæ­¥å®Œæˆ]
    
    Compensation --> Start
    
    style Start fill:#e1f5ff,stroke:#0288d1,stroke-width:3px
    style PullPhase fill:#fff9c4,stroke:#f57f17,stroke-width:3px
    style PushPhase fill:#ffe0b2,stroke:#e64a19,stroke-width:3px
    style Complete fill:#81c784,stroke:#2e7d32,stroke-width:3px
    style Compensation fill:#ffccbc,stroke:#d84315,stroke-width:2px
```

### ğŸ”½ é˜¶æ®µä¸€ï¼šPullï¼ˆä¸‹è¡ŒåŒæ­¥ï¼‰

ä»è¿œç«¯æ‹‰å–æ•°æ®ï¼Œæ›´æ–°æœ¬åœ°æ•°æ®åº“ã€‚

```mermaid
graph TD
    Start[å¼€å§‹ Pull é˜¶æ®µ] --> FetchRemote[æŸ¥è¯¢è¿œç«¯æ•°æ®<br/>WHERE updated_at > lastPulledAt]
    
    FetchRemote --> ProcessRemote[éå†å¤„ç†æ¯æ¡è¿œç«¯è®°å½•]
    
    ProcessRemote --> FindLocal{æŸ¥æ‰¾æœ¬åœ°è®°å½•<br/>é€šè¿‡ remote_id æˆ–å”¯ä¸€é”®}
    
    FindLocal -->|æ‰¾åˆ° + è¿œç«¯å·²åˆ é™¤| MarkDelete[æ ‡è®°ä¸ºåˆ é™¤]
    FindLocal -->|æ‰¾åˆ° + è¿œç«¯æ›´æ–°| MarkUpdate[æ ‡è®°ä¸ºæ›´æ–°]
    FindLocal -->|æœªæ‰¾åˆ°| MarkCreate[æ ‡è®°ä¸ºåˆ›å»º]
    
    MarkDelete --> ApplyChanges[WatermelonDB.synchronize<br/>åº”ç”¨ Pull ç»“æœ]
    MarkUpdate --> ApplyChanges
    MarkCreate --> ApplyChanges
    
    ApplyChanges --> Suppress[æŠ‘åˆ¶è®¡æ•°å™¨ +1<br/>é˜²æ­¢è§¦å‘è‡ªåŠ¨åŒæ­¥]
    Suppress --> WriteLocal[æ‰¹é‡å†™å…¥æœ¬åœ°æ•°æ®åº“<br/>created/updated/deleted]
    WriteLocal --> UpdateTimestamp[æ›´æ–° lastPulledAt = pullStartedAt]
    
    UpdateTimestamp --> Complete[âœ… Pull é˜¶æ®µå®Œæˆ]
    
    style Start fill:#fff9c4,stroke:#f57f17,stroke-width:3px
    style Complete fill:#c8e6c9,stroke:#388e3c,stroke-width:2px
    style Suppress fill:#f3e5f5
```

**Pull é˜¶æ®µæ ¸å¿ƒé€»è¾‘ï¼š**

```typescript
async runPullPhase({ models, ctx, lastPulledAt }) {
  for (const model of models) {
    const adapter = model.createAdapter(this.database);
    
    // 1. ä»è¿œç«¯æ‹‰å–å¢é‡æ•°æ®
    const { created, updated, deleted } = await adapter.pull(
      lastPulledAt,
      ctx
    );
    
    // 2. è¿”å›ç»™ WatermelonDB åº”ç”¨åˆ°æœ¬åœ°
    return {
      changes: { [model.table]: { created, updated, deleted } },
      timestamp: Date.now()  // æ–°çš„ lastPulledAt
    };
  }
}
```

**å…³é”®æ­¥éª¤ï¼š**

1. **æŸ¥è¯¢è¿œç«¯** - åªæ‹‰å– `updated_at > lastPulledAt` çš„è®°å½•ï¼ˆå¢é‡åŒæ­¥ï¼‰
2. **åŒ¹é…æœ¬åœ°** - é€šè¿‡ `remote_id` æˆ– `uniqueKey` æ‰¾åˆ°å¯¹åº”æœ¬åœ°è®°å½•
3. **åˆ†ç±»å¤„ç†**ï¼š
   - è¿œç«¯å·²åˆ é™¤ â†’ æ ‡è®°æœ¬åœ°åˆ é™¤
   - æœ¬åœ°ä¸å­˜åœ¨ â†’ æ ‡è®°ä¸ºåˆ›å»º
   - æœ¬åœ°å­˜åœ¨ â†’ æ ‡è®°ä¸ºæ›´æ–°
4. **æ‰¹é‡å†™å…¥** - WatermelonDB åœ¨æŠ‘åˆ¶ä¸Šä¸‹æ–‡ä¸­æ‰¹é‡åº”ç”¨å˜æ›´
5. **æ›´æ–°æ—¶é—´æˆ³** - è®°å½•æœ¬æ¬¡åŒæ­¥æ—¶é—´ç‚¹

### ğŸ”¼ é˜¶æ®µäºŒï¼šPushï¼ˆä¸Šè¡ŒåŒæ­¥ï¼‰

æ¨é€æœ¬åœ°å˜æ›´åˆ°è¿œç«¯ã€‚

```mermaid
graph TD
    Start[å¼€å§‹ Push é˜¶æ®µ] --> CollectChanges[WatermelonDB æ”¶é›†æœ¬åœ°å˜æ›´<br/>created/updated/deleted]
    
    CollectChanges --> HasChanges{æœ‰æœ¬åœ°å˜æ›´?}
    
    HasChanges -->|å¦| Complete
    HasChanges -->|æ˜¯| PushDeletes[â‘  æ¨é€åˆ é™¤<br/>è½¯åˆ é™¤æ ‡è®° is_deleted=true]
    
    PushDeletes --> PushUpserts[â‘¡ æ¨é€åˆ›å»º/æ›´æ–°<br/>éå† created + updated]
    PushUpserts --> CheckRemoteId{æœ¬åœ°è®°å½•<br/>æœ‰ remote_id?}
    
    CheckRemoteId -->|æœ‰| CompareTime{è¿œç«¯æ—¶é—´æˆ³<br/>æ›´æ–°?}
    CheckRemoteId -->|æ— | InsertRemote[INSERT è¿œç«¯è®°å½•<br/>è·å–æ–° remote_id]
    
    CompareTime -->|æ˜¯| Skip[è·³è¿‡æ¨é€<br/>é¿å…è¦†ç›–æ–°æ•°æ®]
    CompareTime -->|å¦| UpdateRemote[UPDATE è¿œç«¯è®°å½•]
    
    InsertRemote --> WriteBack[å†™å› remote_id åˆ°æœ¬åœ°<br/>æŠ‘åˆ¶åŒæ­¥]
    UpdateRemote --> WriteBack
    
    WriteBack --> Complete[âœ… Push é˜¶æ®µå®Œæˆ]
    Skip --> Complete
    
    style Start fill:#ffe0b2,stroke:#e64a19,stroke-width:3px
    style Complete fill:#c8e6c9,stroke:#388e3c,stroke-width:2px
    style WriteBack fill:#f3e5f5
```

**Push é˜¶æ®µæ ¸å¿ƒé€»è¾‘ï¼š**

```typescript
async runPushPhase({ models, ctx, changes }) {
  for (const model of models) {
    const adapter = model.createAdapter(this.database);
    const tableChanges = changes[model.table];
    
    if (!tableChanges) continue;
    
    // 1. å…ˆæ¨é€åˆ é™¤ï¼ˆè½¯åˆ é™¤æ ‡è®°ï¼‰
    await this.pushDeletes(tableChanges.deleted);
    
    // 2. åæ¨é€åˆ›å»ºå’Œæ›´æ–°
    for (const record of [...tableChanges.created, ...tableChanges.updated]) {
      // æ£€æŸ¥æ˜¯å¦æœ‰ remote_id
      if (record.remoteId) {
        // æœ‰ remote_id â†’ UPDATE è¿œç«¯
        await supabase
          .from(model.remoteTable)
          .update(model.localToRemote(record, ctx))
          .eq('id', record.remoteId);
      } else {
        // æ—  remote_id â†’ INSERT è¿œç«¯
        const { data } = await supabase
          .from(model.remoteTable)
          .insert(model.localToRemote(record, ctx))
          .select()
          .single();
        
        // å†™å› remote_id åˆ°æœ¬åœ°ï¼ˆæŠ‘åˆ¶åŒæ­¥ï¼‰
        await this.writeBackRemoteId(record, data.id);
      }
    }
  }
}
```

**å…³é”®æ­¥éª¤ï¼š**

1. **æ”¶é›†å˜æ›´** - WatermelonDB è‡ªåŠ¨è¿½è¸ªæœ¬åœ°å˜æ›´
2. **å…ˆåˆ é™¤ååˆ›å»º** - é¿å…ä¸»é”®/å”¯ä¸€é”®å†²çª
3. **åˆ¤æ–­æ“ä½œç±»å‹**ï¼š
   - æœ‰ `remote_id` â†’ UPDATE è¿œç«¯è®°å½•
   - æ—  `remote_id` â†’ INSERT æ–°è®°å½•
4. **æ—¶é—´æˆ³å†²çªæ£€æµ‹** - é¿å…è¦†ç›–è¿œç«¯æ›´æ–°çš„æ•°æ®
5. **å†™å› remote_id** - åœ¨æŠ‘åˆ¶ä¸Šä¸‹æ–‡ä¸­æ›´æ–°æœ¬åœ°è®°å½•

### ğŸ”‘ å…³é”®é¡ºåºè¯´æ˜

#### 1. **ä¸ºä»€ä¹ˆå…ˆ Pull å Pushï¼Ÿ**

è¿™æ˜¯ WatermelonDB çš„è®¾è®¡åŸåˆ™ï¼Œç¡®ä¿æ•°æ®ä¸€è‡´æ€§ï¼š

```typescript
// DataSyncManager.ts - runSingleSyncCycle
await synchronize({
  database: this.database,
  
  // â‘  å…ˆæ‰§è¡Œ Pull
  pullChanges: async ({ lastPulledAt }) => {
    return await this.runPullPhase({ models, ctx, lastPulledAt });
  },
  
  // â‘¡ åæ‰§è¡Œ Push
  pushChanges: async ({ changes }) => {
    return await this.runPushPhase({ models, ctx, changes });
  },
});
```

**æ‰§è¡Œé¡ºåºçš„å¥½å¤„ï¼š**

| é¡ºåº | é˜¶æ®µ | ä½œç”¨ | ç»“æœ |
|------|------|------|------|
| â‘  | **Pull å…ˆæ‰§è¡Œ** | ä»è¿œç«¯è·å–æœ€æ–°æ•°æ® | æœ¬åœ°æ•°æ®åº“æ›´æ–°åˆ°æœ€æ–°çŠ¶æ€ |
| â‘¡ | **Push åæ‰§è¡Œ** | æ¨é€æœ¬åœ°å˜æ›´ | æ¨é€çš„æ˜¯ç»“åˆäº†è¿œç«¯æœ€æ–°æ•°æ®åçš„çŠ¶æ€ |

**åœºæ™¯ç¤ºä¾‹ï¼š**

```
åˆå§‹çŠ¶æ€ï¼š
- æœ¬åœ°ä»»åŠ¡ Aï¼štitle = "å†™æ–‡æ¡£"ï¼ˆæœ¬åœ°ä¿®æ”¹ï¼ŒæœªåŒæ­¥ï¼‰
- è¿œç«¯ä»»åŠ¡ Aï¼štitle = "æ’°å†™æŠ€æœ¯æ–‡æ¡£"ï¼ˆå…¶ä»–è®¾å¤‡ä¿®æ”¹ï¼‰

åŒæ­¥æµç¨‹ï¼š
1. Pull é˜¶æ®µï¼šå‘ç°è¿œç«¯æ›´æ–° â†’ æœ¬åœ°æ›´æ–°ä¸º "æ’°å†™æŠ€æœ¯æ–‡æ¡£"
2. Push é˜¶æ®µï¼šæ”¶é›†æœ¬åœ°å˜æ›´ â†’ å‘ç°æ²¡æœ‰æœªåŒæ­¥çš„å˜æ›´ï¼ˆå› ä¸ºå·²è¢« Pull è¦†ç›–ï¼‰
3. ç»“æœï¼šé¿å…äº†å†²çªï¼Œæœ¬åœ°å’Œè¿œç«¯ä¸€è‡´

å¦‚æœé¡ºåºåè¿‡æ¥ï¼ˆå…ˆ Push å Pullï¼‰ï¼š
1. Push é˜¶æ®µï¼šæ¨é€ "å†™æ–‡æ¡£" åˆ°è¿œç«¯ â†’ è¦†ç›–äº† "æ’°å†™æŠ€æœ¯æ–‡æ¡£"
2. Pull é˜¶æ®µï¼šä»è¿œç«¯æ‹‰å– "å†™æ–‡æ¡£" 
3. ç»“æœï¼šå…¶ä»–è®¾å¤‡çš„ä¿®æ”¹ä¸¢å¤±äº†ï¼âŒ
```

#### 2. **Push å†…éƒ¨çš„æ‰§è¡Œé¡ºåº**

Push é˜¶æ®µå†…éƒ¨ä¹Ÿæœ‰ä¸¥æ ¼é¡ºåºï¼š

```typescript
async push(changes) {
  // â‘  å…ˆå¤„ç†åˆ é™¤
  await this.pushDeletes(changes.deleted);
  
  // â‘¡ åå¤„ç†åˆ›å»ºå’Œæ›´æ–°
  await this.pushUpserts([
    ...changes.created,
    ...changes.updated
  ]);
}
```

**ä¸ºä»€ä¹ˆå…ˆåˆ é™¤ååˆ›å»ºï¼Ÿ**

é¿å…ä¸»é”®å†²çªï¼š

```
åœºæ™¯ï¼šç”¨æˆ·åˆ é™¤ä»»åŠ¡ Aï¼Œç„¶ååˆ›å»ºäº†åŒåä»»åŠ¡ A'

é”™è¯¯é¡ºåºï¼ˆå…ˆåˆ›å»ºååˆ é™¤ï¼‰ï¼š
1. åˆ›å»ºä»»åŠ¡ A' â†’ ä¸»é”®å†²çªï¼ˆA è¿˜åœ¨ï¼‰âŒ
2. åˆ é™¤ä»»åŠ¡ A

æ­£ç¡®é¡ºåºï¼ˆå…ˆåˆ é™¤ååˆ›å»ºï¼‰ï¼š
1. åˆ é™¤ä»»åŠ¡ A â†’ ä¸»é”®é‡Šæ”¾
2. åˆ›å»ºä»»åŠ¡ A' â†’ æˆåŠŸ âœ…
```

#### 3. **æ—¶é—´æˆ³è·å–æ—¶æœº**

Pull é˜¶æ®µå¼€å§‹å‰å°±è·å–æœåŠ¡å™¨æ—¶é—´æˆ³ï¼š

```typescript
async runPullPhase({ lastPulledAt }) {
  // â‘  å…ˆè·å–æœåŠ¡å™¨æ—¶é—´æˆ³ï¼ˆä½œä¸ºæœ¬æ¬¡ Pull çš„å¼€å§‹æ—¶é—´ï¼‰
  const pullStartedAt = await this.fetchServerTime();
  
  // â‘¡ æŸ¥è¯¢ updated_at > lastPulledAt çš„æ•°æ®
  const rows = await supabase
    .from('tasks')
    .select('*')
    .gte('updated_at', new Date(lastPulledAt).toISOString());
  
  // â‘¢ Pull å®Œæˆåï¼Œæ›´æ–° lastPulledAt = pullStartedAt
  return { changes, timestamp: pullStartedAt };
}
```

**ä¸ºä»€ä¹ˆä¸ç”¨ Pull ç»“æŸæ—¶çš„æ—¶é—´ï¼Ÿ**

é¿å…é—æ¼æ•°æ®ï¼š

```
åœºæ™¯ï¼šPull è€—æ—¶ 5 ç§’

é”™è¯¯åšæ³•ï¼ˆç”¨ Pull ç»“æŸæ—¶é—´ï¼‰ï¼š
10:00:00 - Pull å¼€å§‹
10:00:02 - è¿œç«¯æ’å…¥æ–°è®°å½• X
10:00:05 - Pull ç»“æŸï¼Œè®¾ç½® lastPulledAt = 10:00:05
ä¸‹æ¬¡ Pullï¼šæŸ¥è¯¢ updated_at > 10:00:05 çš„æ•°æ®
ç»“æœï¼šè®°å½• X ä¸¢å¤±ï¼âŒï¼ˆå› ä¸ºå®ƒçš„æ—¶é—´æˆ³æ˜¯ 10:00:02ï¼‰

æ­£ç¡®åšæ³•ï¼ˆç”¨ Pull å¼€å§‹æ—¶é—´ï¼‰ï¼š
10:00:00 - è·å– pullStartedAt = 10:00:00ï¼ŒPull å¼€å§‹
10:00:02 - è¿œç«¯æ’å…¥æ–°è®°å½• X
10:00:05 - Pull ç»“æŸï¼Œè®¾ç½® lastPulledAt = 10:00:00
ä¸‹æ¬¡ Pullï¼šæŸ¥è¯¢ updated_at > 10:00:00 çš„æ•°æ®
ç»“æœï¼šè®°å½• X ä¼šè¢«æ‹‰å– âœ…
```

---

## æ•°æ®ä¸€è‡´æ€§ä¿è¯æœºåˆ¶

è¿™æ˜¯æ•´ä¸ªæ–¹æ¡ˆæœ€æ ¸å¿ƒçš„éƒ¨åˆ†ã€‚æˆ‘ä»¬é€šè¿‡å¤šå±‚æœºåˆ¶ç¡®ä¿æ•°æ®åœ¨å¤æ‚åœºæ™¯ä¸‹çš„ä¸€è‡´æ€§ã€‚

### â±ï¸ 1. æ—¶é—´æˆ³å†²çªæ£€æµ‹

**åœºæ™¯ï¼š** ç”¨æˆ·åœ¨æ‰‹æœºå’Œç”µè„‘ä¸ŠåŒæ—¶ç¼–è¾‘åŒä¸€æ¡ç¬”è®°ã€‚

**è§£å†³æ–¹æ¡ˆï¼š**

1. åŒç«¯ç»´æŠ¤ `updated_at` æ—¶é—´æˆ³ï¼ˆæ¯«ç§’ç²¾åº¦ï¼‰
2. Pull æ—¶æ¯”è¾ƒ `remoteUpdatedAt > localUpdatedAt`ï¼Œè¿œç«¯æ›´æ–°åˆ™è¦†ç›–æœ¬åœ°
3. Push æ—¶å…ˆæŸ¥è¯¢è¿œç«¯æœ€æ–°æ—¶é—´æˆ³ï¼Œå¦‚æœè¿œç«¯æ›´æ–°åˆ™è·³è¿‡æ¨é€ï¼ˆé¿å…è¦†ç›–ï¼‰

```typescript
// ä¸‹è¡ŒåŒæ­¥æ—¶çš„å†²çªæ£€æµ‹
if (isFinite(remoteUpdated) && remoteUpdated > localUpdated) {
  // è¿œç«¯æ›´æ–°ï¼Œè¦†ç›–æœ¬åœ°
  updated.push({ ...remoteToLocal(row), id: localRecord.id });
}

// ä¸Šè¡ŒåŒæ­¥æ—¶çš„å†²çªæ£€æµ‹
const remoteRow = await fetchRemoteRow(remoteTable, remoteId);
const remoteUpdated = Date.parse(remoteRow.updated_at);
const localUpdated = Number(model.updatedAt);

if (remoteUpdated >= localUpdated) {
  // è¿œç«¯æ›´æ–°ï¼Œè·³è¿‡æ¨é€ï¼ˆé¿å…è¦†ç›–æ–°æ•°æ®ï¼‰
  return;
}
```

**å†²çªè§£å†³ç­–ç•¥ï¼š** "**Last Write Wins**"ï¼ˆåå†™å…¥è·èƒœï¼‰- ç®€å•é«˜æ•ˆï¼Œé€‚åˆç»å¤§å¤šæ•°åœºæ™¯ã€‚

### ğŸ”‘ 2. å”¯ä¸€é”®åŒ¹é…

**åœºæ™¯ï¼š** ç”¨æˆ·åœ¨ç¦»çº¿çŠ¶æ€ä¸‹åˆ›å»ºäº†ä¸€æ¡ä»»åŠ¡ï¼Œéšååœ¨å¦ä¸€å°è®¾å¤‡ä¹Ÿåˆ›å»ºäº†åŒåä»»åŠ¡ã€‚

**é—®é¢˜ï¼š** å¦‚ä½•é¿å…åŒæ­¥åäº§ç”Ÿé‡å¤æ•°æ®ï¼Ÿ

**è§£å†³æ–¹æ¡ˆï¼š** è”åˆå”¯ä¸€é”®åŒ¹é…

```typescript
static syncKeys = {
  remotePk: 'id',
  localRemoteId: 'remote_id',
  uniqueKey: [
    { local: 'title', remote: 'title' },
    { local: 'user_id', remote: 'user_id' }
  ]  // è”åˆå”¯ä¸€é”®ï¼štitle + user_id
};
```

**åŒæ­¥æµç¨‹ï¼š**

1. é¦–æ¬¡åŒæ­¥æ—¶ï¼Œç³»ç»Ÿå…ˆæ„å»ºæœ¬åœ°å”¯ä¸€é”®ç´¢å¼• `Map<uniqueKey, localRecord>`
2. å¯¹äºæ¯æ¡è¿œç«¯è®°å½•ï¼Œå…ˆå°è¯•é€šè¿‡ `remote_id` åŒ¹é…
3. å¦‚æœåŒ¹é…å¤±è´¥ï¼Œå†é€šè¿‡ `uniqueKey` åŒ¹é…
4. åŒ¹é…æˆåŠŸåˆ™æ›´æ–°ï¼Œå¤±è´¥åˆ™åˆ›å»ºæ–°è®°å½•

```typescript
// æ„å»ºæœ¬åœ°å”¯ä¸€é”®ç´¢å¼•
const uniqueIndex = await buildUniqueIndex(uniqueSpecs);
// uniqueIndex: Map { "ä»»åŠ¡A##user123" => localRecord1, ... }

// åŒ¹é…è¿œç«¯è®°å½•
let localRecord = await findByRemoteId(row.id);
if (!localRecord) {
  const uniqueKey = getRemoteUniqueKey(row, uniqueSpecs);
  localRecord = uniqueIndex.get(uniqueKey);
}
```

**å…³é”®ç‚¹ï¼š**
- æ”¯æŒå•ä¸€æˆ–è”åˆå”¯ä¸€é”®ï¼ˆæ•°ç»„ï¼‰
- æ”¯æŒ JSON è·¯å¾„ï¼ˆå¦‚ `data.email`ï¼‰
- å‘ç°é‡å¤å”¯ä¸€é”®ä¼šæŠ›å‡ºé”™è¯¯ï¼Œç¡®ä¿æ•°æ®å®Œæ•´æ€§

### ğŸ—‘ï¸ 3. è½¯åˆ é™¤æœºåˆ¶

**ä¸ºä»€ä¹ˆä¸èƒ½ç¡¬åˆ é™¤ï¼Ÿ**

ç¡¬åˆ é™¤ä¼šå¯¼è‡´åŒæ­¥ä¿¡æ¯ä¸¢å¤±ï¼š
- è®¾å¤‡ A åˆ é™¤è®°å½•åï¼Œè®¾å¤‡ B æ— æ³•æ„ŸçŸ¥è¿™æ¬¡åˆ é™¤
- è®¾å¤‡ B ä¸‹æ¬¡åŒæ­¥æ—¶ä¼šå°†"å·²åˆ é™¤çš„è®°å½•"é‡æ–°æ¨é€åˆ°äº‘ç«¯ï¼ˆåƒµå°¸æ•°æ®ï¼‰

**è½¯åˆ é™¤æ–¹æ¡ˆï¼š**

```typescript
// æœ¬åœ°åˆ é™¤æ—¶ï¼Œæ ‡è®° is_deleted = trueï¼Œè€Œéç‰©ç†åˆ é™¤
await task.update(t => {
  t.isDeleted = true;
  t.updatedAt = Date.now();
});

// Push æ—¶å°†è½¯åˆ é™¤æ ‡è®°åŒæ­¥åˆ°è¿œç«¯
const { error } = await supabase
  .from('tasks')
  .update({ is_deleted: true, updated_at: new Date().toISOString() })
  .eq('id', remoteId);

// Pull æ—¶è¯†åˆ«è½¯åˆ é™¤ï¼Œè§¦å‘æœ¬åœ°åˆ é™¤
if (row.is_deleted) {
  deleted.push(localRecord.id);
}
```

**æ•°æ®æ¸…ç†ï¼š** å®šæœŸé€šè¿‡åå°ä»»åŠ¡ç‰©ç†åˆ é™¤ `is_deleted=true` ä¸”è¶…è¿‡ N å¤©çš„è®°å½•ã€‚

### ğŸ”„ 4. è¡¥å¿å¾ªç¯ï¼ˆCompensation Cyclesï¼‰

**åœºæ™¯ï¼š** åŒæ­¥è¿‡ç¨‹ä¸­æœ¬åœ°æ•°æ®è¢«ä¿®æ”¹ï¼Œå¦‚ä½•ç¡®ä¿æ•°æ®æœ€ç»ˆä¸€è‡´ï¼Ÿ

**é—®é¢˜ç¤ºä¾‹ï¼š**

1. Pull é˜¶æ®µï¼šä»è¿œç«¯æ‹‰å– 100 æ¡è®°å½•å¹¶å†™å…¥æœ¬åœ°
2. è¿™ä¼šè§¦å‘ WatermelonDB çš„ `onChange` äº‹ä»¶
3. å¦‚æœç«‹å³è§¦å‘æ–°çš„åŒæ­¥ï¼Œä¼šå¯¼è‡´é€’å½’åŒæ­¥

**è§£å†³æ–¹æ¡ˆï¼šè¡¥å¿å¾ªç¯ + æŠ‘åˆ¶è®¡æ•°å™¨**

```typescript
async runSyncLoop(models, ctx) {
  this.isSyncing = true;
  
  // æŒç»­åŒæ­¥ç›´åˆ°ç¨³å®š
  while (true) {
    await runSingleSyncCycle(models, ctx);  // Pull + Push
    
    if (!this.hasPendingChange) {
      break;  // æ²¡æœ‰æ–°çš„å˜æ›´ï¼Œé€€å‡ºå¾ªç¯
    }
    
    // æœ‰æ–°å˜æ›´ï¼Œæ‰§è¡Œè¡¥å¿å¾ªç¯
    this.hasPendingChange = false;
  }
  
  this.isSyncing = false;
}
```

**æŠ‘åˆ¶è®¡æ•°å™¨ï¼ˆSuppressionCounterï¼‰ï¼š**

```typescript
// Pull å†™å…¥æœ¬åœ°æ—¶ï¼ŒæŠ‘åˆ¶åŒæ­¥è§¦å‘
runSuppressed(async () => {
  await database.write(async () => {
    await model.update(m => {
      m.remoteId = remoteId;
      m.updatedAt = remoteUpdatedAt;
    });
  });
});

// æœ¬åœ°å˜æ›´ç›‘å¬å™¨ä¸­æ£€æŸ¥æŠ‘åˆ¶çŠ¶æ€
onLocalChanged(changes) {
  if (!checkAndDecrement()) {
    return;  // æ­£åœ¨æŠ‘åˆ¶ä¸­ï¼Œå¿½ç•¥æ­¤æ¬¡å˜æ›´
  }
  
  this.scheduleAutoSync();
}
```

**æµç¨‹å›¾ï¼š**

```mermaid
graph TD
    Start[å¼€å§‹åŒæ­¥] --> Pull[Pull: å†™å…¥æœ¬åœ°<br/>æŠ‘åˆ¶è®¡æ•°å™¨ +1]
    Pull --> OnChange[è§¦å‘ onChange äº‹ä»¶]
    OnChange --> Check1{checkAndDecrement<br/>æ£€æµ‹åˆ°æŠ‘åˆ¶?}
    Check1 -->|æ˜¯| Ignore[å¿½ç•¥äº‹ä»¶]
    
    Start --> Push[Push: æ¨é€æœ¬åœ°å˜æ›´]
    Push --> LocalChange{æœ¬åœ°æœ‰æ–°å¢/ä¿®æ”¹?}
    LocalChange -->|æ˜¯| SetPending[è®¾ç½® hasPendingChange = true]
    LocalChange -->|å¦| CheckPending
    
    Ignore --> CheckPending{æ£€æŸ¥ hasPendingChange}
    SetPending --> CheckPending
    
    CheckPending -->|true| Compensate[æ‰§è¡Œè¡¥å¿å¾ªç¯]
    CheckPending -->|false| Complete[åŒæ­¥å®Œæˆ]
    
    Compensate --> Start
    
    style Start fill:#e1f5ff
    style Pull fill:#fff4e6
    style Push fill:#fff4e6
    style Complete fill:#c8e6c9
    style Compensate fill:#ffccbc
```

### âš¡ 5. é˜²æŠ–ä¸æ‰¹é‡å¤„ç†

**åœºæ™¯ï¼š** ç”¨æˆ·å¿«é€Ÿè¿ç»­è¾“å…¥ç¬”è®°æ ‡é¢˜ï¼Œæ¯æ¬¡æŒ‰é”®éƒ½è§¦å‘åŒæ­¥ï¼Ÿ

**è§£å†³æ–¹æ¡ˆï¼šAutoSyncController é˜²æŠ–**

```typescript
export class AutoSyncController {
  private debounceTimer: any;
  
  trigger(onTrigger: () => void) {
    // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
    if (this.debounceTimer) clearTimeout(this.debounceTimer);
    
    // è®¾ç½®æ–°çš„å®šæ—¶å™¨ï¼ˆé»˜è®¤ 3000msï¼‰
    this.debounceTimer = setTimeout(() => {
      this.debounceTimer = null;
      onTrigger();
    }, this.debounceMs);
  }
}
```

**æ•ˆæœï¼š** è¿ç»­ç¼–è¾‘ 10 ç§’å†…åªè§¦å‘ä¸€æ¬¡åŒæ­¥ï¼Œå¤§å¹…å‡å°‘ç½‘ç»œè¯·æ±‚ã€‚

### ğŸ“¡ 6. å®æ—¶è®¢é˜…ï¼ˆRemote Subscriptionsï¼‰

**åœºæ™¯ï¼š** ç”¨æˆ·åœ¨æ‰‹æœºä¸ŠæŸ¥çœ‹ä»»åŠ¡åˆ—è¡¨ï¼Œæ­¤æ—¶ç”µè„‘ä¸Šå®Œæˆäº†ä¸€ä¸ªä»»åŠ¡ï¼Œå¦‚ä½•å®æ—¶æ›´æ–°ï¼Ÿ

**è§£å†³æ–¹æ¡ˆï¼šSupabase Realtime + è‡ªåŠ¨åŒæ­¥è§¦å‘**

```typescript
// å¯åŠ¨è¿œç«¯å®æ—¶è®¢é˜…
syncManager.startRemoteSubscriptions();

// SupabaseAdapter å®ç°
subscribeToRemoteChanges(ctx, onChange) {
  const channel = supabase.channel(`sync-${this.ModelCtor.table}`)
    .on('postgres_changes', {
      event: '*',
      schema: 'public',
      table: this.ModelCtor.remoteTable,
      filter: `user_id=eq.${ctx.userId}`  // ä»…è®¢é˜…å½“å‰ç”¨æˆ·æ•°æ®
    }, (payload) => {
      // è§¦å‘åŒæ­¥
      onChange?.(payload);
    })
    .subscribe();
  
  return {
    unsubscribe: () => supabase.removeChannel(channel)
  };
}
```

**æ™ºèƒ½æš‚åœæœºåˆ¶ï¼š** Push æœŸé—´æš‚åœè¯¥è¡¨çš„è®¢é˜…ï¼Œé¿å…è‡ªå·±è§¦å‘è‡ªå·±

```typescript
// Push å‰æš‚åœè®¢é˜…
if (wasSubscribed) {
  this.unsubscribeFromModel(label);
}

try {
  await adapter.push(changes, ctx);
} finally {
  // Push åç«‹å³æ¢å¤è®¢é˜…
  if (wasSubscribed) {
    this.subscribeToModel(ctor, label);
  }
}
```

### ğŸ” 7. è¿œç«¯ ID å›å†™ï¼ˆRemote ID Write-backï¼‰

**åœºæ™¯ï¼š** æœ¬åœ°åˆ›å»ºä¸€æ¡è®°å½•ï¼ŒPush åˆ°è¿œç«¯åè·å¾—è¿œç«¯ IDï¼Œå¦‚ä½•å…³è”ï¼Ÿ

#### é—®é¢˜ï¼šå›å†™å¯¼è‡´å¾ªç¯åŒæ­¥

å½“æˆ‘ä»¬å†™å› `remote_id` åˆ°æœ¬åœ°æ•°æ®åº“æ—¶ï¼Œä¼šé‡åˆ°ä¸€ä¸ªæ£˜æ‰‹çš„é—®é¢˜ï¼š

```typescript
// âŒ å±é™©æ“ä½œï¼šç›´æ¥å†™å›ä¼šè§¦å‘å¾ªç¯
await model.update(m => {
  m.remoteId = remoteId;  // è¿™ä¼šè§¦å‘ WatermelonDB çš„ onChange äº‹ä»¶
  m.updatedAt = remoteUpdated;
});

// onChange äº‹ä»¶è¢«è§¦å‘
// â†’ AutoSyncController ç›‘å¬åˆ°å˜æ›´
// â†’ è§¦å‘æ–°çš„åŒæ­¥
// â†’ Push æ—¶å†æ¬¡å†™å›
// â†’ åˆè§¦å‘ onChange
// â†’ æ— é™å¾ªç¯ï¼ğŸ’¥
```

**æ ¸å¿ƒçŸ›ç›¾ï¼š**
- æˆ‘ä»¬å¿…é¡»å†™å› `remote_id` å’Œ `updated_at`ï¼ˆå»ºç«‹æœ¬åœ°-è¿œç«¯å…³è”ï¼‰
- ä½†ä»»ä½•æœ¬åœ°æ•°æ®åº“çš„å†™æ“ä½œéƒ½ä¼šè§¦å‘ `onChange` äº‹ä»¶
- å¦‚æœä¸å¤„ç†ï¼Œä¼šå¯¼è‡´æ— é™å¾ªç¯åŒæ­¥

#### è§£å†³æ–¹æ¡ˆï¼šæŠ‘åˆ¶è®¡æ•°å™¨ï¼ˆSuppressionCounterï¼‰

æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªå…¨å±€è®¡æ•°å™¨æ¥æ ‡è®°"è¿™æ˜¯åŒæ­¥è¿‡ç¨‹ä¸­çš„å†…éƒ¨å†™æ“ä½œï¼Œä¸åº”è¯¥è§¦å‘æ–°çš„åŒæ­¥"ï¼š

```typescript
// SuppressionCounter.ts
let suppressionDepth = 0;

// åœ¨æŠ‘åˆ¶ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œå‡½æ•°
export function runSuppressed<T>(fn: () => Promise<T>): Promise<T> {
  suppressionDepth += 1;  // è¿›å…¥æŠ‘åˆ¶ä¸Šä¸‹æ–‡ï¼Œè®¡æ•°å™¨ +1
  return fn();
}

// æ£€æŸ¥æ˜¯å¦åº”è¯¥è§¦å‘åŒæ­¥
export function checkAndDecrement(): boolean {
  const wasZero = suppressionDepth <= 0;  // è®¡æ•°å™¨ä¸º 0 è¯´æ˜æ˜¯çœŸå®çš„ç”¨æˆ·æ“ä½œ
  suppressionDepth = Math.max(0, suppressionDepth - 1);  // è®¡æ•°å™¨ -1
  return wasZero;  // è¿”å› true è¡¨ç¤ºåº”è¯¥è§¦å‘åŒæ­¥
}
```

#### å®Œæ•´çš„å·¥ä½œæµç¨‹

```mermaid
sequenceDiagram
    participant User as ç”¨æˆ·åˆ›å»ºä»»åŠ¡
    participant Local as æœ¬åœ°æ•°æ®åº“
    participant Sync as åŒæ­¥ç®¡ç†å™¨
    participant Remote as è¿œç«¯æ•°æ®åº“
    participant Counter as æŠ‘åˆ¶è®¡æ•°å™¨
    
    User->>Local: åˆ›å»ºæ–°ä»»åŠ¡
    Local->>Sync: onChange äº‹ä»¶
    Sync->>Counter: checkAndDecrement()
    Counter-->>Sync: true (è®¡æ•°å™¨=0ï¼Œè§¦å‘åŒæ­¥)
    
    Sync->>Remote: Push æ–°ä»»åŠ¡
    Remote-->>Sync: è¿”å› remote_id = "abc123"
    
    Note over Sync,Counter: è¿›å…¥æŠ‘åˆ¶ä¸Šä¸‹æ–‡
    Sync->>Counter: runSuppressed() â†’ è®¡æ•°å™¨+1
    Sync->>Local: å†™å› remote_id = "abc123"
    Local->>Sync: onChange äº‹ä»¶ (ç”±å›å†™è§¦å‘)
    Sync->>Counter: checkAndDecrement()
    Counter->>Counter: è®¡æ•°å™¨-1
    Counter-->>Sync: false (è®¡æ•°å™¨>0ï¼Œå¿½ç•¥æ­¤äº‹ä»¶)
    
    Note over Sync: å›å†™å®Œæˆï¼Œä¸è§¦å‘æ–°åŒæ­¥ âœ…
```

#### ä»£ç å®ç°

```typescript
// 1. Push é˜¶æ®µï¼šåˆ›å»ºè¿œç«¯è®°å½•
const { data } = await supabase
  .from('tasks')
  .insert(payload)
  .select();

const remoteId = data[0].id;

// 2. åœ¨æŠ‘åˆ¶ä¸Šä¸‹æ–‡ä¸­å†™å›æœ¬åœ°
await writeBackRemoteId(model, {
  localRemoteId: 'remote_id',
  remoteId: remoteId,
  remoteUpdatedAtKey: 'updated_at',
  remoteRow: data[0]
});

// writeBackRemoteId å†…éƒ¨å®ç°
async function writeBackRemoteId(model, params) {
  const updateData = async () => {
    await database.write(async () => {
      await model.update(m => {
        m.remoteId = params.remoteId;        // å†™å›è¿œç«¯ ID
        m.updatedAt = params.remoteUpdatedAt; // åŒæ­¥æ—¶é—´æˆ³
      });
    });
  };
  
  // âœ… å…³é”®ï¼šåœ¨æŠ‘åˆ¶ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œ
  await runSuppressed(updateData);
}

// 3. AutoSyncController ä¸­çš„å˜æ›´ç›‘å¬
onLocalChanged(changes) {
  // âœ… æ£€æŸ¥æŠ‘åˆ¶çŠ¶æ€
  if (!checkAndDecrement()) {
    // è®¡æ•°å™¨ > 0ï¼Œè¯´æ˜æ˜¯åŒæ­¥å†…éƒ¨æ“ä½œï¼Œå¿½ç•¥
    return;
  }
  
  // è®¡æ•°å™¨ = 0ï¼Œè¯´æ˜æ˜¯çœŸå®ç”¨æˆ·æ“ä½œï¼Œè§¦å‘åŒæ­¥
  if (!changes || !this.running) return;
  
  if (this.isSyncing) {
    this.hasPendingChange = true;
    return;
  }
  
  this.scheduleAutoSync();
}
```

#### å…³é”®ç‚¹æ€»ç»“

| åœºæ™¯ | suppressionDepth | checkAndDecrement() | è¡Œä¸º |
|------|-----------------|---------------------|------|
| **ç”¨æˆ·åˆ›å»ºä»»åŠ¡** | 0 | true | âœ… è§¦å‘åŒæ­¥ |
| **Pull å†™å…¥æœ¬åœ°** | 1 | false | âŒ å¿½ç•¥ï¼ˆåŒæ­¥å†…éƒ¨æ“ä½œï¼‰ |
| **å›å†™ remote_id** | 1 | false | âŒ å¿½ç•¥ï¼ˆåŒæ­¥å†…éƒ¨æ“ä½œï¼‰ |
| **åŒæ­¥å®Œæˆåç”¨æˆ·ç¼–è¾‘** | 0 | true | âœ… è§¦å‘åŒæ­¥ |

**ä¸ºä»€ä¹ˆéœ€è¦è®¡æ•°å™¨è€Œä¸æ˜¯å¸ƒå°”å€¼ï¼Ÿ**

å› ä¸ºå¯èƒ½å­˜åœ¨åµŒå¥—çš„å†™æ“ä½œï¼š
```typescript
runSuppressed(async () => {
  await model1.update(...);  // æ·±åº¦ 1
  await runSuppressed(async () => {
    await model2.update(...);  // æ·±åº¦ 2
  });
});
// åªæœ‰æ‰€æœ‰æŠ‘åˆ¶ä¸Šä¸‹æ–‡éƒ½é€€å‡ºåï¼Œæ‰èƒ½è§¦å‘åŒæ­¥
```

**åŒæ­¥å®Œæ•´æ€§ä¿è¯ï¼š**
- âœ… çœŸå®ç”¨æˆ·æ“ä½œ â†’ ç«‹å³è§¦å‘åŒæ­¥
- âœ… åŒæ­¥å†…éƒ¨å†™å› â†’ ä¸è§¦å‘å¾ªç¯
- âœ… åµŒå¥—å†™æ“ä½œ â†’ æ­£ç¡®å¤„ç†
- âœ… å¹¶å‘å®‰å…¨ â†’ å•çº¿ç¨‹ JavaScript ä¿è¯åŸå­æ€§

---

## é«˜çº§ç‰¹æ€§

### è‡ªå®šä¹‰é€‚é…å™¨

å¦‚æœä½ ä½¿ç”¨çš„ä¸æ˜¯ Supabaseï¼Œå¯ä»¥å®ç°è‡ªå®šä¹‰é€‚é…å™¨ï¼š

```typescript
import { BaseSyncAdapter, PullResult, TableChanges } from '@/lib/sync';

export class FirebaseAdapter extends BaseSyncAdapter {
  async pull(lastPulledAt: number | null, ctx?: SyncContext): Promise<PullResult> {
    // å®ç° Firebase æ‹‰å–é€»è¾‘
    const snapshot = await firebase
      .collection(this.ModelCtor.remoteTable)
      .where('updated_at', '>', lastPulledAt)
      .where('user_id', '==', ctx.userId)
      .get();
    
    // è½¬æ¢ä¸º PullResult æ ¼å¼
    return {
      created: [...],
      updated: [...],
      deleted: [...]
    };
  }
  
  async push(changes: TableChanges, ctx?: SyncContext): Promise<void> {
    // å®ç° Firebase æ¨é€é€»è¾‘
    // ...
  }
}

// åœ¨ Model ä¸­æŒ‡å®šä½¿ç”¨è‡ªå®šä¹‰é€‚é…å™¨
export class Task extends SyncModel {
  protected static createAdapter(database, ModelCtor, defaultCtx) {
    return new FirebaseAdapter(database, ModelCtor);
  }
}
```

### æ¡ä»¶åŒæ­¥ï¼ˆRecord-Level Filteringï¼‰

æŸäº›è®°å½•å¯èƒ½ä¸éœ€è¦åŒæ­¥åˆ°äº‘ç«¯ï¼ˆå¦‚ä¸´æ—¶è‰ç¨¿ï¼‰ï¼Œå¯ä»¥é€šè¿‡ `shouldSyncLocal` æ§åˆ¶ï¼š

```typescript
export class Draft extends SyncModel {
  @field('is_synced') isSynced!: boolean;
  
  async shouldSyncLocal(ctx: SyncContext): Promise<boolean> {
    // åªåŒæ­¥å·²æ ‡è®°ä¸º"éœ€åŒæ­¥"çš„è‰ç¨¿
    return this.isSynced;
  }
}
```

### å†²çªå›è°ƒï¼ˆConflict Hooksï¼‰

è™½ç„¶é»˜è®¤ä½¿ç”¨"åå†™å…¥è·èƒœ"ç­–ç•¥ï¼Œä½†ä½ å¯ä»¥ç›‘å¬å†²çªäº‹ä»¶å¹¶è‡ªå®šä¹‰å¤„ç†ï¼š

```typescript
syncManager.on((event) => {
  if (event.type === 'conflict') {
    const { localRecord, remoteRecord } = event.detail;
    
    // è‡ªå®šä¹‰å†²çªè§£å†³é€»è¾‘
    const merged = mergeConflicts(localRecord, remoteRecord);
    await localRecord.update(merged);
  }
});
```

---

## æ•…éšœæ’æŸ¥

### å¸¸è§é—®é¢˜

**1. å¾ªç¯åŒæ­¥ï¼ˆæ•°æ®åå¤æ›´æ–°ï¼‰**

**åŸå› ï¼š** æœªæ­£ç¡®ä½¿ç”¨æŠ‘åˆ¶è®¡æ•°å™¨

**è§£å†³ï¼š** å†™å› `remote_id` æ—¶ä½¿ç”¨ `runSuppressed`

```typescript
// æ­£ç¡®
runSuppressed(async () => {
  await model.update(m => m.remoteId = remoteId);
});

// é”™è¯¯ï¼šç›´æ¥æ›´æ–°ä¼šè§¦å‘æ–°çš„åŒæ­¥
await model.update(m => m.remoteId = remoteId);
```

**2. å”¯ä¸€é”®å†²çª**

**é”™è¯¯ä¿¡æ¯ï¼š** `Local unique key duplicated for tasks: ...`

**åŸå› ï¼š** æœ¬åœ°å­˜åœ¨å¤šæ¡è®°å½•å…·æœ‰ç›¸åŒå”¯ä¸€é”®

**è§£å†³ï¼š** æ£€æŸ¥æ•°æ®å®Œæ•´æ€§çº¦æŸ

```sql
-- åœ¨ Supabase ä¸­æ·»åŠ å”¯ä¸€çº¦æŸ
ALTER TABLE tasks 
ADD CONSTRAINT tasks_title_user_unique 
UNIQUE (title, user_id);
```

**3. æ—¶é—´æˆ³ä¸åŒæ­¥**

**ç°è±¡ï¼š** Pull åç«‹å³ Push ç›¸åŒæ•°æ®

**åŸå› ï¼š** å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨æ—¶é—´åå·®

**è§£å†³ï¼š** ä½¿ç”¨æœåŠ¡å™¨æ—¶é—´

```typescript
// è·å–æœåŠ¡å™¨æ—¶é—´
const { timestamp } = await getServerTime();

// æ›´æ–°è®°å½•æ—¶ä½¿ç”¨æœåŠ¡å™¨æ—¶é—´
await model.update(m => {
  m.updatedAt = timestamp;
});
```

---

## è‡´è°¢

è¿™ä¸ªé¡¹ç›®çš„çµæ„Ÿæ¥æºäºï¼š

- [WatermelonDB](https://github.com/Nozbe/WatermelonDB) - å‡ºè‰²çš„ç§»åŠ¨ç«¯æ•°æ®åº“
- [Supabase](https://supabase.com/) - å¼ºå¤§çš„åç«¯å³æœåŠ¡å¹³å°
- [RxDB](https://rxdb.info/) - å¦ä¸€ä¸ªä¼˜ç§€çš„å“åº”å¼æ•°æ®åº“æ–¹æ¡ˆ

---

## å…³æ³¨ä¸äº¤æµ

å¦‚æœè¿™ç¯‡æ–‡ç« å¯¹ä½ æœ‰å¸®åŠ©ï¼Œæ¬¢è¿ï¼š

- â­ **Star é¡¹ç›®**ï¼š[github.com/Morphicai/watermelondb-sync-model](https://github.com/Morphicai/watermelondb-sync-model)
- ğŸ’¬ **åˆ†äº«ç»éªŒ**ï¼šåœ¨ GitHub Issues ä¸­åˆ†äº«ä½ çš„è¸©å‘ç»éªŒå’Œè§£å†³æ–¹æ¡ˆ
- ğŸ› **æŠ¥å‘Šé—®é¢˜**ï¼šå‘ç° Bug æˆ–æœ‰æ”¹è¿›å»ºè®®ï¼Ÿæäº¤ Issue æˆ– PR
- ğŸ“– **äº¤æµè®¨è®º**ï¼šåœ¨ Discussions ä¸­è®¨è®ºåŒæ­¥æ¶æ„ã€æœ€ä½³å®è·µ

**ä½ çš„å®è·µç»éªŒå¯¹å…¶ä»–å¼€å‘è€…å¾ˆæœ‰ä»·å€¼ï¼** æ— è®ºæ˜¯æˆåŠŸæ¡ˆä¾‹è¿˜æ˜¯è¸©è¿‡çš„å‘ï¼Œéƒ½æ¬¢è¿åœ¨ GitHub ä¸Šåˆ†äº«ã€‚

---

## æ€»ç»“

æœ¬æ–‡ä»‹ç»äº†ç™¾å˜AIåŠ©æ‰‹ä¸­ Offline First æ•°æ®åŒæ­¥çš„å®Œæ•´å®ç°ï¼š

**æ ¸å¿ƒå†…å®¹ï¼š**
- æ¶æ„è®¾è®¡ï¼šSyncModel æŠ½è±¡ã€é€‚é…å™¨æ¨¡å¼ã€äº‹ä»¶é©±åŠ¨
- ä¸€è‡´æ€§ä¿è¯ï¼šæ—¶é—´æˆ³å†²çªæ£€æµ‹ã€å”¯ä¸€é”®åŒ¹é…ã€è½¯åˆ é™¤ã€è¡¥å¿å¾ªç¯ã€æŠ‘åˆ¶è®¡æ•°å™¨
- å·¥ç¨‹å®è·µï¼šPull/Push é¡ºåºã€æ—¶é—´æˆ³è·å–ã€è¿œç«¯ ID å›å†™
- å¸¸è§é™·é˜±ï¼šå¾ªç¯åŒæ­¥ã€å”¯ä¸€é”®å†²çªã€æ—¶é—´æˆ³ä¸åŒæ­¥

**å…³äºå¼€æºä»£ç ï¼š**

ä»£ç ä¸æ˜¯å¼€ç®±å³ç”¨çš„ï¼Œè¿™æ˜¯ä»ç”Ÿäº§ç¯å¢ƒä¸­æå–çš„æ ¸å¿ƒé€»è¾‘ã€‚æ–‡ç« è¯¦ç»†è¯´æ˜äº†å®ç°åŸç†å’Œæˆ‘ä»¬é‡åˆ°çš„é—®é¢˜ï¼Œè¿™äº›ç»éªŒå¯ä»¥å¸®åŠ©ä½ é¿å…åŒæ ·çš„å‘ã€‚é…åˆ AI å·¥å…·ï¼ˆClaudeã€GPT-4 ç­‰ï¼‰å¯ä»¥å¿«é€Ÿç†è§£å¹¶é€‚é…åˆ°è‡ªå·±çš„é¡¹ç›®ä¸­ã€‚

---

## ğŸŒŸ æˆ‘çš„å…¶ä»–å¼€æºé¡¹ç›®

| é¡¹ç›® | æè¿° |
|------|------|
| [MorphixAI Code](https://github.com/Morphicai/morphixai-code) | å¯ä»¥åˆ©ç”¨ Cursor / Claude Code ç­‰ AI å·¥å…·å¿«é€Ÿä¸Šçº¿è‡ªå·±çš„å°å·¥å…· |
| [Awesome MorphixAI Apps](https://github.com/Morphicai/awesome-morphix-apps) | åŸºäº MorphixAI Code çš„åº”ç”¨æ¡ˆä¾‹é›†åˆï¼Œå±•ç¤ºæœ€ä½³å®è·µ |

---

*æœ¬æ–‡æ’°å†™äº 2025 å¹´ 10 æœˆï¼ŒåŸºäº watermelondb-sync-model v1.0.0*
